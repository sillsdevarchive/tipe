#!/usr/bin/python
# -*- coding: utf-8 -*-
# version: 20110704
# By Dennis Drescher (dennis_drescher at sil.org)


###############################################################################
######################### Description/Documentation ###########################
###############################################################################

# One script to rule them all.  This is the mother script of the whole system.
# This script will drive all processes and keep track of what happens in the
# project log in each respective project.

# History:
# 20110610 - djd - Start initial draft
# 20110704 - djd - Start refactor for multiple component types
# 20110721 - djd - Added proper command line processing
# 20110729 - djd - Removed TIPE system settings from project folder


###############################################################################
################################ Initialize TIPE ##############################
###############################################################################
# Firstly, import all the standard Python modules we need for this process and
# set the base path

import sys, os, codecs, shutil, operator
from datetime import *
from configobj import ConfigObj

# Basic startup functions

def initUserHome (userHome) :
	'''Dumb user home init function'''

	# Create core home paths
	tipeFile            = os.path.join(userHome, 'tipe.conf')
	resources           = os.path.join(userHome, 'resources')

	# Create home folders
	if not os.path.isdir(userHome) :
		os.mkdir(userHome)

	if not os.path.isdir(resources) :
		os.mkdir(resources)

	# Make the default global tipe.conf for custom environment settings
	if not os.path.isfile(tipeFile) :
		date_time = tStamp()
		tipe = ConfigObj()
		tipe.filename = tipeFile
		tipe['System'] = {}
		tipe['Folders'] = {}
		tipe['Projects'] = {}
		tipe['System']['userName'] = 'Default User'
		tipe['System']['initDate'] = date_time
		tipe['System']['writeOutUserConfFile'] = 'True'
		# Folder list
		folders = ['fonts', 'illustrations', 'admin', 'compTypes', 'projTypes']
		# System folders
		for f in folders :
			tipe['Folders']['tipe' + f] = os.path.join(tipeHome, 'resources', 'lib_' + f)
		# User (home) folders
		for f in folders :
			thisFolder = os.path.join(userHome, 'resources', 'lib_' + f)
			tipe['Folders']['user' + f] = thisFolder
			if not os.path.isdir(thisFolder) :
				os.mkdir(thisFolder)

		# Write out the user config file
		tipe.write()

# Set the TIPE base program path
tipeHome = os.environ.get('TIPE_BASE')
if not tipeHome :
	tipeHome = os.path.join('usr', 'share', 'xetex-tipe')
	os.environ['TIPE_BASE'] = tipeHome

# Set the user environment path
userHome = os.environ.get('TIPE_USER')
if not userHome :
	sysHome = os.environ.get('HOME')
	userHome = os.path.join(sysHome, '.config', 'tipe')
	os.environ['TIPE_USER'] = userHome

# Set the (potential) project home
projHome = os.getcwd()

# Before we get started we need to do some preliminary tests to see what the
# environment we are starting in looks like.  That will determine where we go
# from here.

# Set our paths to application resources
sys.path.insert(0, os.path.join(tipeHome, 'bin', 'python'))
sys.path.insert(0, os.path.join(tipeHome, 'bin', 'python', 'lib_system'))

# Now that our path is good we can load the local classes
from tools import *
from sys_command import Command, commands
from project import Project

# Load in system user information for TIPE startup

# Check to see if the file is there, then read it in and break it into
# sections. If it fails, scream really loud!
tipeXML = os.path.join(tipeHome, 'bin', 'tipe.xml')
if os.path.exists(tipeXML) :
	sysXmlConfig = xml_to_section(tipeXML)
else :
	raise IOError, "Can't open " + tipeXML

# Now get the settings from the users global tipe.conf file
tipeUser = os.path.join(userHome, 'tipe.conf')
if not os.path.exists(tipeUser) :
	initUserHome(userHome)

# Load the conf file into an object
tipeConfig = ConfigObj(tipeUser)

# Look for any projects that might be registered and record them
try :
	tipeProjs = tipeConfig['Projects']
except :
	tipeProjs = None

# FIXME: this is broken, it returns None
# Create a new conf object based on all the XML default settings
# Then override them with any exsiting user settings.
userConfig = ConfigObj(sysXmlConfig.dict()).override(tipeConfig)

# Put back any project information that we might have lost from
# the XML/conf file merging.
if tipeProjs :
	userConfig['Projects'] = tipeProjs

# Load in project settings if they exist in the cwd
projConfFile = os.path.join(userHome, '.project.conf')
if os.path.isfile(projConfFile) :
	# Find out what kind of project this is
	oldProjConfig = ConfigObj(projConfFile)
	projType = oldProjConfig['ProjectInfo']['projectType']
	# Load in the project type XML default settings
	projXMLFile = os.path.join(tipeHome, 'resources', 'lib_projTypes', projType, projType + '.xml')
	if os.path.exists(projXMLFile) :
		projXmlConfig = xml_to_section(projXMLFile)
	else :
		raise IOError, "Can't open " + projXMLFile
	# Create a new conf object based on all the XML default settings
	# Then override them with any exsiting project settings.
	projConfig = ConfigObj(projXmlConfig.dict()).override(oldProjConfig)
	aProject = Project(projConfig, userConfig, os.getcwd(), userPath, basePath)
else :
	aProject = None


###############################################################################
############################### Terminal Startup ##############################
###############################################################################

# Give a welcome message
terminal('\n\t\tWelcome to TIPE ' + userConfig['System']['systemVersion'])
terminal('\t\tCurrent User: ' + userConfig['System']['userName'])

# FIXME: The following needs review and revision
# TIPE Command Line Syntax
# The tipe program can take numerious command.  Each command has two parts, a
# command name, and a set of 0 or more options.  A command option starts with
# "-" and is followed by a parameter.  If a wrong parameter is entered that will
# be caught by the command when it tries to run.
# They are:
#   tipe [command] [-optA param] [-optB param]
#
# Whereas:
# tipe          = the script name, which is always "tipe"
# [command]     = tipe command (none = manager)
# [-optA param] = A specified option and parameter
#
# If no command is given, then a list of commands will be given.  If the user
# wants specific help on a command they would type:
#   tipe command -help

command = ""
opts = []

if len(sys.argv) > 1 :
	command = sys.argv[1]
	opts = sys.argv[2:]
else :
	# If there isn't anything then we'll just go to the projects manager
	command = "help"
	terminal('\nAvailable commands:')


###############################################################################
##################### Prepare and Process TIPE Commands #######################
###############################################################################

# Run the command and pass along the aProject object
if command in commands :
	if len(opts) != 0 :
		commands[command].run(opts, aProject, userConfig)
	else :
		commands[command].run(opts)
else :
	terminal('ERROR: This command does not exist: ' + command)

# Now write out the config files if needed
writeConfFiles(userConfig, aProject, userHome, projHome)

## Politely say good bye
terminal('\n\t\tThank you, please come again!\n')

