#!/usr/bin/python
# -*- coding: utf-8 -*-
# version: 20110610
# By Dennis Drescher (dennis_drescher at sil.org)


###############################################################################
######################### Description/Documentation ###########################
###############################################################################

# One script to rule them all.  This is the mother script of the whole system.
# This script will drive all processes and keep track of what happens in the
# project log in each respective project.

# History:
# 20110610 - djd - Initial draft


###############################################################################
################################## Load Modules ###############################
###############################################################################
# Firstly, import all the standard Python modules we need for this process and
# set the base path

import sys, os, codecs, shutil, operator


basePath = os.environ.get('TIPE_BASE')
if not basePath :
	basePath = "/usr/share/xetex-tipe"
	os.environ['TIPE_BASE'] = basePath

# Before we get started we need to do some preliminary tests to see what the
# environment we are starting in looks like.  That will determine where we go
# from here.

# Set our paths to application resources
sys.path.insert(0, basePath + '/bin/python')
sys.path.insert(0, basePath + '/bin/python/lib_system')

# Load the local classes
from report import *
report = Report()
from configure import *
configure = Configure()
from document import *
document = Document()


# Give a welcome message
sysConfig = configure.getSystem()
version = sysConfig['System']['systemVersion']

report.terminal('\n\t\tWelcome to TIPE ' + version + '\n')

# Examine our command line.  The command line will have no more than three
# parameters.  The script name, which is always "tipe", followed by the command
# and then the component code, if a component is to be processed.  Otherwise,
# the command could be followed by a single parameter that the system will
# attempt to parse if the command is expecting more than one parameter.

command = ""
thisComponent = ""

if len(sys.argv) > 3 :
	report.terminal('Dude, you messed up your command line. Try again!')

elif len(sys.argv) > 1 :
	command = sys.argv[1]
	try :
		thisComponent = sys.argv[2]
	except :
		thisComponent = ""

else :
	# If there isn't anything then we'll just go to the projects manager
	command = "projects"


###############################################################################
########################## Define Script functions ############################
###############################################################################

def newProject () :
	'''Setup a new project'''

	if project.makeProject(os.getcwd()) :
		report.writeToLog('MSG', 'Created new project at: ' + os.getcwd())
	else :
		report.terminal('ERROR: tipe.newProject: Failed to created new project at: ' + os.getcwd())


def addComponent () :
	'''Add a new component to the project.'''

	component.addComponent(thisComponent)


def render () :
	'''Render the current component.'''

	# First check our project setup and try to auto correct any problems that
	# might be caused from missing project assets.  This can include files
	# like.sty, .tex, .usfm, and folders, etc.
	if not project.checkProject(os.getcwd()) :
		report.terminal('ERROR: tipe.render: No project found!')
		return

	# Now see if this component exists
	if not component.checkComponent(thisComponent) :
		report.writeToLog('ERR', 'tipe.render: Component not found in project.')
		return

	# Create the makefile for processing this particular component.  This is
	# done every time TIPE is run.
	if document.createMakefile(thisComponent, command) :
		if runMake() :
			report.writeToLog('MSG', 'Process completed successful!')
		else :
			report.writeToLog('ERR', 'Process did not complete successfuly. Check logs for more information.')

	# Collect the results and report them in the log

	return


def runMake () :
	'''All component processes are expected to be run via makefile.  This is a
	generic makefile running function.'''

	# Send off the command return error code
	error = os.system(sysConfig['System']['makeStartParams'] + os.getcwd() + '/' + sysConfig['System']['makefileFile'])

	if error == 0 :
		return True
	else :
		report.terminal('ERROR: tipe.runMake: ' + str(error))
		return



# Define more script functions here

###############################################################################
########################## Main Body of the Script ############################
###############################################################################

# Load up the shared modules we're going to need for all the commands
from project import *
project = Project()


if command == 'render' :
	render()
elif command == 'new_project' :
	newProject()
elif command == 'add_component' :
	addComponent()
else :
	report.terminal('ERROR: This command does not exist: ' + command)


# All done
report.trimLog()
report.terminal('\n\t\tThank you, please come again!\n')

